version: "3.8"

services:
    # Backend Services

    file-service:
        build:
            context: ./services/file-service
            dockerfile: Dockerfile
        ports:
            - "8080:8080"
            - "9464:9464"
        environment:
            - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
        restart: always

    postgres-service:
        build:
            context: ./services/postgres-service
            dockerfile: Dockerfile
        ports:
            - "8082:8082"
        environment:
            - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
            - POSTGRES_HOST=postgres
        restart: always

    mongo-service:
        build:
            context: ./services/mongo-service
            dockerfile: Dockerfile
        ports:
            - "8081:8081"
        environment:
            - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
            - MONGO_URI=mongodb://mongo:27017
        restart: always

    db-service:
        build:
            context: ./services/db-service
            dockerfile: Dockerfile
        ports:
            - "8083:8083"
        depends_on:
            - mongo-service
            - postgres-service
        environment:
            - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
            - MONGO_SERVICE_URL=http://mongo-service:8081
            - POSTGRES_SERVICE_URL=http://postgres-service:8082
            - KAFKA_SERVICE_URL=http://kafka-service:8084
        restart: always

    kafka-service:
        build:
            context: ./services/kafka-service
            dockerfile: Dockerfile
        ports:
            - "8084:8084"
        environment:
            - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
            - KAFKA_BROKERS=kafka:9092
        restart: always

    kafka-receiver-a:
        build:
            context: ./services/kafka-receiver-a
            dockerfile: Dockerfile
        ports:
            - "8085:8085"
        environment:
            - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
            - KAFKA_BROKERS=kafka:9092
            - POSTGRES_HOST=postgres
        restart: always

    kafka-receiver-b:
        build:
            context: ./services/kafka-receiver-b
            dockerfile: Dockerfile
        ports:
            - "8086:8086"
        environment:
            - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
            - KAFKA_BROKERS=kafka:9092
            - MONGO_URI=mongodb://mongo:27017
        restart: always

    bff-service:
        build:
            context: ./services/bff-service
            dockerfile: Dockerfile
        ports:
            - "8087:8087"
        depends_on:
            - file-service
            - db-service
            - kafka-service
        environment:
            - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
            - FILE_SERVICE_URL=http://file-service:8080
            - DB_SERVICE_URL=http://db-service:8083
            - KAFKA_SERVICE_URL=http://kafka-service:8084
        restart: always

    # # Frontends
    # spa-react:
    #     build:
    #         context: ./apps/spa-react
    #         dockerfile: Dockerfile
    #     ports:
    #     - "3001:3001"
    #     restart: always

    ssr-react:
        build:
            context: ./apps/ssr-react
            dockerfile: Dockerfile
        ports:
            - "3002:3002"
        depends_on:
            - bff-service
        environment:
            - BFF_URL=http://bff-service:8087
            - NEXT_PUBLIC_BFF_URL=http://localhost:8087
            - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
            - SERVICE_VERSION=1.0.0
        restart: always

    # mf-spa-react:
    #     build:
    #         context: ./apps/mf-spa-react
    #         dockerfile: Dockerfile
    #     ports:
    #     - "3003:3003"
    #     restart: always

    # mf-remote-ui:
    #     build:
    #         context: ./apps/mf-remote-ui
    #         dockerfile: Dockerfile
    #     ports:
    #     - "3004:3004"
    #     restart: always
